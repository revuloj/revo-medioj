version: '3.1'

services:
  formiko:
    image: voko-formiko
    build: 
      context: .
      dockerfile: Dockerfile
    # restart: always

  afido:
    image: voko-afido
    build: https://github.com/revuloj/voko-afido.git
    # command: processmail.pl
    volumes:
      - xml:/home/afido/dict/xml # la artikoloj, devas esti kreita per "cvs co"
      - afido:/var/afido # tmp, log
      - mail:/var/mail
    secrets:
      - voko.redaktantoj
      - voko-afido.smtp_server
      - voko-afido.smtp_user
      - voko-afido.smtp_password

  tomocero:
    image: voko-tomocero
    build: 
      context: .
      dockerfile: Dockerfile
    command: /usr/lib/postfix/master -d
    volumes:
      # eble ni eksterigu ankaŭ /var/spool/postfix resp. tutan /var/spool
      - mail:/var/mail
      - spool:/var/spool
    secrets:
      - voko-tomocero.pop3_server
      - voko-tomocero.pop3_user
      - voko-tomocero.pop3_password
      - voko-tomocero.myhostname
      - voko-tomocero.saslpassword
      - voko-tomocero.relayhost
      - voko-tomocero.relayaddress
      - voko-tomocero.relaypassword

  vaneso-cvs:
    image: voko-vaneso
    build: https://github.com/revuloj/voko-vaneso.git
    command: mirror.pl cvs
    volumes:
      - mirrordat:/home/vaneso/mirrordat
      - log:/home/vaneso/log

  vaneso-revo:
    image: voko-vaneso
    build: https://github.com/revuloj/voko-vaneso.git
    command: mirror.pl revo
    volumes:
      - mirrordat:/home/vaneso/mirrordat
      - log:/home/vaneso/log

# kreu sekretojn ekzemple tiel, kondiĉe ke vi uzas propran poŝtfakon
# redaktoservo@provizanto.org por ricevi kaj forsendi artikolojn
#   echo "mail.provizanto.org" | docker secret create voko-afido.pop3_server -
#   echo "redaktoservo@provizanto.org" | docker secret create voko-afido.pop3_user -
#   echo "MiaTr3SekretaP4svorto" | docker secret create voko-afido.pop3_password -
#   
#   echo "smtp.provizanto.org" | docker secret create voko-afido.smtp_server -
#   echo "redaktoservo@provizanto.org" | docker secret create voko-afido.smtp_user -
#   echo "MiaTr3SekretaP4svorto" | docker secret create voko-afido.smtp_password -
# Uzante la procesumon voko-tomocero por forsendo de retpoŝtoj vi anstataŭe donu por smtp
# la sekvan agordon. La avantaĝo estas, ke tomocero transsendas la retpoŝtojn en serioj
# kaj tiel ne por ĉiu unuopa retpoŝto okazas rekonekto, kion kelkaj provizantoj
# malhelpas per kelkminuta deviga paŭzo.
#   echo "voko-tomocero" | docker secret create voko-afido.smtp_server -
#   echo "" | docker secret create voko-afido.smtp_user -
#   echo "" | docker secret create voko-afido.smtp_password -

secrets:
  voko-tomocero.pop3_server:
    external: true
  voko-tomocero.pop3_user:
    external: true
  voko-tomocero.pop3_password:
    external: true
  voko-tomocero.myhostname:
    external: true
  voko-tomocero.saslpassword:
    external: true
  voko-tomocero.relayhost:
    external: true
  voko-tomocero.relayaddress:
    external: true
  voko-tomocero.relaypassword:
    external: true
  voko-afido.smtp_server:
    external: true
  voko-afido.smtp_user:
    external: true
  # sama kiel sasl-password, ĉu?
  voko-afido.smtp_password:
    external: true
  voko.redaktantoj:
    #external: true
    file: ${HOME}/etc/redaktantoj

volumes:
  mail:
  spool:
  xml:
  mirrordat:
  log:
  afido:
  


